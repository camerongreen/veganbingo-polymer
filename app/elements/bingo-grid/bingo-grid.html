<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import"
      href="../../bower_components/core-layout-grid/core-layout-grid.html">

<link rel="import" href="../grid-button/grid-button.html">

<polymer-element name="bingo-grid" attributes="tiles, score, total">
  <template>
    <app-globals id="globals"></app-globals>
    <bingo-data id="ajax" tiles="{{tiles}}"></bingo-data>
    <bingo-settings id="settings"></bingo-settings>
    <link rel="stylesheet" href="bingo-grid.css">
    <template repeat="{{row in gridTiles}}">
      <div horizontal layout>
        <template repeat="{{tile in row}}">
          <grid-button details="{{tile}}" flex class="{{tile.tileClass}}"></grid-button>
        </template>
      </div>
    </template>
  </template>
  <script>
    (function () {
      function calculateRowSize(size) {
        for (var i = 0; i < size; i++) {
          if ((i * i) >= size) {
            return i;
          }
        }

        return size;
      }

      /**
       * The number of tile styles should equal the number of tiles in each row
       * and be named 'style1', 'style2' etc
       *
       * @param tiles
       * @param numInRow
       */
      function makeGrid(tiles, numInRow) {
        var returnVal = [];
        var currRow = [];

        for (var tile in tiles) {
          if (tiles.hasOwnProperty(tile)) {
            var styleNum = (returnVal.length + currRow.length) % numInRow;
            var style = "style" + (styleNum + 1);

            var newElement = Object.create(tiles[tile]);

            newElement.tileId = tile;
            newElement.tileClass = style;

            currRow.push(newElement);

            if (currRow.length == numInRow) {
              returnVal.push(currRow.slice(0));
              currRow = [];
            }
          }
        }

        if (currRow.length > 0) {
          returnVal.push(currRow);
        }

        return returnVal;
      }

      Polymer({
        ready: function () {
          var that = this;
          this.$.ajax.addEventListener('core-response', function (res) {
            that.tiles = res.detail.response;
          })
        },
        toggleDone: function (elId) {
          var done = this.tiles[elId].done;
          if (done) {
            this.tiles[elId].done = false;
          } else {
            this.tiles[elId].done = Date.now();
          }
          this.tilesChanged();
          return this.tiles[elId].done;
        },
        persist: function () {
          var newSettings = {};
          for (var tile in this.tiles) {
            if (this.tiles.hasOwnProperty(tile) && (this.tiles[tile].done !== false)) {
              newSettings[tile] = this.tiles[tile].done;
            }
          }
          this.$.settings.persist(newSettings);
        },
        restart: function () {
          for (var tile in this.tiles) {
            if (this.tiles.hasOwnProperty(tile)) {
              this.tiles[tile].done = false;
            }
          }
          this.tilesChanged();
        },
        count: function (countAll) {
          var count = 0;
          for (var tile in this.tiles) {
            if (this.tiles.hasOwnProperty(tile)) {
              if (countAll || (this.tiles[tile].done !== false)) {
                count++;
              }
            }
          }
          return count;
        },
        tilesChanged: function () {
          if (this.$.globals.objLength(this.tiles)) {
            this.gridTiles = makeGrid(this.tiles, calculateRowSize(this.$.globals.objLength(this.tiles)));
            this.total = this.count(true);
            this.score = this.count();
            this.persist();
          }
        }
      });
    })();
  </script>
</polymer-element>
